name: Sync To Gitee

on:
  #push:
    #branches: [ main ]  # 可根据需要修改分支
  schedule:
    - cron: '0 5 * * *'  # 每天 UTC 时间 1:00（即北京时间 9:00）

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout (required by git-mirror-action)
        uses: actions/checkout@v4

      - name: Sync to Gitee with Retry
        env:
          SSH_PRIVATE_KEY: ${{ secrets.GITEE_RSA_PRIVATE_KEY }}
        run: |
          MAX_RETRIES=3
          RETRY_DELAY=10

          for i in $(seq 1 $MAX_RETRIES); do
            echo "🔄 Attempt $i of $MAX_RETRIES to sync to Gitee..."

            # 直接调用 git-mirror-action 的 Docker 命令
            docker run --rm \
              -e SSH_PRIVATE_KEY \
              -v "$PWD:/github/workspace" \
              wearerequired/git-mirror-action:master \
              "git@github.com:MaaAssistantArknights/MaaResource.git" \
              "git@gitee.com:keithchow/MaaResource.git" \
              "false"

            if [ $? -eq 0 ]; then
              echo "✅ Sync succeeded on attempt $i"
              break
            else
              echo "❌ Attempt $i failed. Retrying in $RETRY_DELAY seconds..."
              sleep $RETRY_DELAY
            fi

            if [ $i -eq $MAX_RETRIES ]; then
              echo "💥 All $MAX_RETRIES attempts failed. Exiting."
              exit 1
            fi
          done
